name: Build Android APK

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # çŽ¯å¢ƒå˜é‡ï¼šç‰ˆæœ¬å·å’Œæž„å»ºæ—¶é—´
    env:
      VERSION_NAME: "1.0.0"
      BUILD_TIME: ${{ github.run_number }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´ git åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆç‰ˆæœ¬å·

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Generate version info
      id: version
      run: |
        # èŽ·å–çŸ­æäº¤å“ˆå¸Œ
        SHORT_SHA=$(git rev-parse --short=7 HEAD)
        # èŽ·å–å½“å‰æ—¥æœŸæ—¶é—´
        BUILD_DATE=$(date +'%Y%m%d')
        # æž„å»ºç‰ˆæœ¬å·
        VERSION="${VERSION_NAME}.${BUILD_TIME}+${BUILD_TIME}.${SHORT_SHA}"
        APK_VERSION="v${VERSION_NAME}-${BUILD_DATE}-${SHORT_SHA}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "apk_version=$APK_VERSION" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "Generated Version: $APK_VERSION"

    - name: Grant execute permission for gradlew
      run: |
        chmod +x gradlew

    - name: Build Debug APK
      run: |
        ./gradlew assembleDebug --no-daemon

    - name: Build Release APK (optional)
      run: |
        ./gradlew assembleRelease --no-daemon || echo "Release build skipped"

    - name: Rename APKs
      run: |
        APK_VER="${{ steps.version.outputs.apk_version }}"
        # é‡å‘½å Debug APK
        mv app/build/outputs/apk/debug/app-debug.apk \
           MBBridgeController-${APK_VER}-debug.apk
        # é‡å‘½å Release APKï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -f app/build/outputs/apk/release/app-release.apk ]; then
          mv app/build/outputs/apk/release/app-release.apk \
             MBBridgeController-${APK_VER}-release.apk
        fi
        echo "Renamed APKs to: MBBridgeController-${APK_VER}-[debug|release].apk"

    - name: Verify renamed APKs
      run: |
        APK_VER="${{ steps.version.outputs.apk_version }}"
        echo "=== Checking APK files ==="
        ls -lh *.apk || true
        echo ""
        echo "=== File names ==="
        basename *.apk || true

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: MBBridgeController-${{ steps.version.outputs.apk_version }}-debug
        path: MBBridgeController-${{ steps.version.outputs.apk_version }}-debug.apk
        retention-days: 30

    - name: Upload Release APK (if present)
      if: ${{ hashFiles('MBBridgeController-${{ steps.version.outputs.apk_version }}-release.apk') != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: MBBridgeController-${{ steps.version.outputs.apk_version }}-release
        path: MBBridgeController-${{ steps.version.outputs.apk_version }}-release.apk
        retention-days: 90

    - name: Get APK info
      run: |
        APK_VER="${{ steps.version.outputs.apk_version }}"
        DEBUG_APK="MBBridgeController-${APK_VER}-debug.apk"
        RELEASE_APK="MBBridgeController-${APK_VER}-release.apk"
        SHORT_SHA="${{ steps.version.outputs.short_sha }}"
        BUILD_DATE="${{ steps.version.outputs.build_date }}"

        echo "### ðŸ“± MBBridge Controller æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- æäº¤: \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
        echo "- æ—¥æœŸ: \`${BUILD_DATE}\`" >> $GITHUB_STEP_SUMMARY
        echo "- æž„å»ºå·: \${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“¦ APK æ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
        echo "- Debug: \`${DEBUG_APK}\`" >> $GITHUB_STEP_SUMMARY
        echo "- å¤§å°: $(du -h ${DEBUG_APK} | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "${RELEASE_APK}" ]; then
          echo "- Release: \`${RELEASE_APK}\`" >> $GITHUB_STEP_SUMMARY
          echo "- å¤§å°: $(du -h ${RELEASE_APK} | cut -f1)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Release: æœªç”Ÿæˆï¼ˆå¯èƒ½æœªé…ç½®ç­¾åï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“¥ ä¸‹è½½è¯´æ˜Ž:**" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸‹æ–¹ Artifacts åŒºåŸŸçš„æ–‡ä»¶é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "2. ä¸‹è½½çš„æ˜¯ zip åŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "3. **è§£åŽ‹åŽ**æ‰èƒ½å¾—åˆ° APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "4. è§£åŽ‹åŽçš„æ–‡ä»¶ååŒ…å«å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ ä¸‹è½½ä½ç½®: Actions -> Artifacts" >> $GITHUB_STEP_SUMMARY
